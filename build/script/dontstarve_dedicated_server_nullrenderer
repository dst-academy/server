#!/usr/bin/env bash

if [ `whoami` != "$STEAM_USER" ]; then
	exec gosu $STEAM_USER $0 "$@"
fi

clean_exit(){
	echo -e "\nc_shutdown(true)" > $DSTA_HOME/console
}

trap clean_exit SIGHUP SIGINT SIGQUIT SIGTERM

# We must have at least one writer
sleep infinity > $DSTA_HOME/console &

cd $DST_HOME/bin
./dontstarve_dedicated_server_nullrenderer \
	-console \
	-backup_logs \
	-persistent_storage_root `dirname $CONFIG_PATH` \
	-conf_dir `basename $CONFIG_PATH` \
	"$@" < $DSTA_HOME/console &

wait $! # This one is interrupted by the signal
wait $! # So we wait again to the real finish of dontstarve_dedicated_server_nullrenderer
